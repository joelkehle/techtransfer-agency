services:
  bus:
    build: .
    command: ["agent-bus-v2"]
    ports:
      - "8080:8080"
    environment:
      PORT: "8080"
      STATE_FILE: "/data/state.json"
    volumes:
      - bus-data:/data
    networks:
      - agentnet
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/v1/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  concierge:
    build: .
    command:
      - concierge
      - -bus-url=http://bus:8080
      - -addr=:8090
      - -web-dir=/app/web
      - -upload-dir=/uploads
    ports:
      - "3000:8090"
    volumes:
      - uploads:/uploads
      - ./web:/app/web:ro
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

  patent-pipeline:
    build: .
    command:
      - patent-pipeline
      - -bus-url=http://bus:8080
    volumes:
      - uploads:/uploads
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

volumes:
  bus-data:
  uploads:

networks:
  agentnet:
