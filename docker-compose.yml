services:
  bus:
    build: .
    command: ["techtransfer-agency"]
    ports:
      - "8080:8080"
    environment:
      PORT: "8080"
      STATE_FILE: "/data/state.json"
    volumes:
      - bus-data:/data
    networks:
      - agentnet
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/v1/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  operator:
    build: .
    command:
      - operator
      - -bus-url=http://bus:8080
      - -addr=:8090
      - -web-dir=/app/web
      - -upload-dir=/uploads
    ports:
      - "3000:8090"
    environment:
      OPERATOR_AGENT_SECRET: ${OPERATOR_AGENT_SECRET:?OPERATOR_AGENT_SECRET is required}
    volumes:
      - uploads:/uploads
      - ./web:/app/web:ro
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

  patent-extractor:
    build: .
    command:
      - patent-extractor
      - -bus-url=http://bus:8080
      - -next-agent-id=patent-screen
    environment:
      PATENT_EXTRACTOR_AGENT_SECRET: ${PATENT_EXTRACTOR_AGENT_SECRET:?PATENT_EXTRACTOR_AGENT_SECRET is required}
    volumes:
      - uploads:/uploads
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

  prior-art-extractor:
    build: .
    command:
      - patent-extractor
      - -bus-url=http://bus:8080
      - -agent-id=prior-art-extractor
      - -capability=prior-art-search
      - -secret-env=PRIOR_ART_EXTRACTOR_AGENT_SECRET
      - -next-agent-id=prior-art-search
    environment:
      PRIOR_ART_EXTRACTOR_AGENT_SECRET: ${PRIOR_ART_EXTRACTOR_AGENT_SECRET:?PRIOR_ART_EXTRACTOR_AGENT_SECRET is required}
    volumes:
      - uploads:/uploads
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

  market-extractor:
    build: .
    command:
      - patent-extractor
      - -bus-url=http://bus:8080
      - -agent-id=market-extractor
      - -capability=market-analysis
      - -secret-env=MARKET_EXTRACTOR_AGENT_SECRET
      - -next-agent-id=market-analysis
    environment:
      MARKET_EXTRACTOR_AGENT_SECRET: ${MARKET_EXTRACTOR_AGENT_SECRET:?MARKET_EXTRACTOR_AGENT_SECRET is required}
    volumes:
      - uploads:/uploads
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

  market-analysis:
    build: .
    command:
      - market-analysis
      - -bus-url=http://bus:8080
      - -agent-id=market-analysis
    environment:
      MARKET_ANALYSIS_AGENT_SECRET: ${MARKET_ANALYSIS_AGENT_SECRET:?MARKET_ANALYSIS_AGENT_SECRET is required}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required}
    volumes:
      - uploads:/uploads
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

  patent-screen:
    build: .
    command:
      - patent-screen
      - -bus-url=http://bus:8080
      - -agent-id=patent-screen
    environment:
      PATENT_SCREEN_AGENT_SECRET: ${PATENT_SCREEN_AGENT_SECRET:?PATENT_SCREEN_AGENT_SECRET is required}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required}
    volumes:
      - uploads:/uploads
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

  prior-art-search:
    build: .
    command:
      - prior-art-search
      - -bus-url=http://bus:8080
      - -agent-id=prior-art-search
    environment:
      PRIOR_ART_AGENT_SECRET: ${PRIOR_ART_AGENT_SECRET:?PRIOR_ART_AGENT_SECRET is required}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required}
      PATENTSVIEW_API_KEY: ${PATENTSVIEW_API_KEY:?PATENTSVIEW_API_KEY is required}
      PRIOR_ART_LLM_MODEL: ${PRIOR_ART_LLM_MODEL:-claude-sonnet-4-20250514}
      PRIOR_ART_MAX_PATENTS: ${PRIOR_ART_MAX_PATENTS:-300}
      PRIOR_ART_MAX_ASSESS: ${PRIOR_ART_MAX_ASSESS:-75}
      PRIOR_ART_BATCH_SIZE: ${PRIOR_ART_BATCH_SIZE:-15}
      PRIOR_ART_RATE_LIMIT: ${PRIOR_ART_RATE_LIMIT:-40}
    volumes:
      - uploads:/uploads
    networks:
      - agentnet
    depends_on:
      bus:
        condition: service_healthy

volumes:
  bus-data:
  uploads:

networks:
  agentnet:
